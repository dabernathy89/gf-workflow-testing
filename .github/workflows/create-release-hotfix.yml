name: Create Release or Hotfix

on:
  workflow_dispatch:
    inputs:
      type:
        description: 'Type of branch to create'
        required: true
        type: choice
        options:
          - release
          - hotfix

jobs:
  create-branch:
    permissions:
      contents: write
      actions: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate branch name
        id: branch_info
        run: |
          # Generate branch name with current date and short commit hash
          CURRENT_DATE=$(date +%Y-%m-%d)
          SHORT_SHA=$(git rev-parse --short HEAD)

          if [ "${{ inputs.type }}" = "release" ]; then
            BRANCH_NAME="release/v${CURRENT_DATE}-${SHORT_SHA}"
          else
            BRANCH_NAME="hotfix/v${CURRENT_DATE}-${SHORT_SHA}"
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“ Generated branch name: $BRANCH_NAME"

      - name: Check if branch already exists
        run: |
          if git ls-remote --heads origin ${{ steps.branch_info.outputs.branch_name }} | grep -q refs; then
            echo "âŒ Branch ${{ steps.branch_info.outputs.branch_name }} already exists"
            exit 1
          fi
          echo "âœ… Branch ${{ steps.branch_info.outputs.branch_name }} is available"

      - name: Create branch
        run: |
          git checkout main
          git checkout -b ${{ steps.branch_info.outputs.branch_name }}
          git push origin ${{ steps.branch_info.outputs.branch_name }}

      - name: Output branch details
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          echo "âœ… ${{ inputs.type }} branch created: $BRANCH_NAME"
          echo "ğŸ“ Created from current main branch"

          echo ""
          echo "ğŸ”„ Next steps:"
          echo "1. Push commits to the branch will trigger release-versioning.yml"
          echo "2. Semantic-release will run and create version/tag"
          echo "3. If successful, a PR will be created automatically"
          echo "4. Review and merge the PR to complete the release"

      - name: Output branch details
        run: |
          if [ "${{ inputs.type }}" = "release" ]; then
            BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
            echo "âœ… Release branch created: $BRANCH_NAME"
            echo "ğŸ“ Created from commit: ${{ inputs.commit_hash }}"
          else
            BRANCH_NAME="${{ steps.parse_version.outputs.branch_name }}"
            echo "âœ… Hotfix branch created: $BRANCH_NAME"
            echo "ğŸ“ Created from tag: ${{ inputs.tag }}"
          fi

          echo ""
          echo "ï¿½ Next steps:"
          echo "1. Push commits to the branch will trigger release-versioning.yml"
          echo "2. Semantic-release will run and create version/tag"
          echo "3. If successful, a PR will be created automatically"
          echo "4. Review and merge the PR to complete the release"
