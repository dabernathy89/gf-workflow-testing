name: Create Release or Hotfix

on:
  workflow_dispatch:
    inputs:
      type:
        description: 'Type of branch to create'
        required: true
        type: choice
        options:
          - release
          - hotfix
      commit_hash:
        description: 'Commit hash to create release from (required for release)'
        required: false
        type: string
      tag:
        description: 'Tag to create hotfix from (required for hotfix, e.g. v1.2.0)'
        required: false
        type: string

jobs:
  create-branch:
    permissions:
      contents: write
      actions: write
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [ "${{ inputs.type }}" = "release" ] && [ -z "${{ inputs.commit_hash }}" ]; then
            echo "❌ Commit hash is required for release type"
            exit 1
          fi

          if [ "${{ inputs.type }}" = "hotfix" ] && [ -z "${{ inputs.tag }}" ]; then
            echo "❌ Tag is required for hotfix type"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: Checkout target commit (release only)
        if: inputs.type == 'release'
        run: git checkout ${{ inputs.commit_hash }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate branch name (release only)
        if: inputs.type == 'release'
        id: branch_info
        run: |
          # Generate branch name with current date and short commit hash
          CURRENT_DATE=$(date +%Y-%m-%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          BRANCH_NAME="release/v${CURRENT_DATE}-${SHORT_SHA}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "📝 Generated branch name: $BRANCH_NAME"

      - name: Parse version from tag (hotfix only)
        if: inputs.type == 'hotfix'
        id: parse_version
        run: |
          TAG="${{ inputs.tag }}"
          CURRENT_DATE=$(date +%Y-%m-%d)
          BRANCH_NAME="hotfix/v${CURRENT_DATE}-${TAG}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "📝 Generated branch name: $BRANCH_NAME"

      - name: Check if branch already exists (release only)
        if: inputs.type == 'release'
        run: |
          if git ls-remote --heads origin ${{ steps.branch_info.outputs.branch_name }} | grep -q refs; then
            echo "❌ Branch ${{ steps.branch_info.outputs.branch_name }} already exists"
            exit 1
          fi
          echo "✅ Branch ${{ steps.branch_info.outputs.branch_name }} is available"

      - name: Create release branch
        if: inputs.type == 'release'
        run: |
          git checkout main
          git checkout -b ${{ steps.branch_info.outputs.branch_name }} ${{ inputs.commit_hash }}
          git push origin ${{ steps.branch_info.outputs.branch_name }}

      - name: Create hotfix branch
        if: inputs.type == 'hotfix'
        run: |
          git checkout -b ${{ steps.parse_version.outputs.branch_name }} ${{ inputs.tag }}
          git push origin ${{ steps.parse_version.outputs.branch_name }}

      - name: Create Release Pull Request
        if: inputs.type == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Release ${{ steps.branch_info.outputs.branch_name }}" \
            --body "🚀 **Release branch ${{ steps.branch_info.outputs.branch_name }}**

          **Created from commit:** \`${{ inputs.commit_hash }}\`

          ## What happens when you push to this branch:
          1. 📝 Semantic-release updates package.json and changelog automatically
          2. 🏷️ Semantic-release creates git tag automatically
          3. ⏸️ Workflow pauses for manual approval in \`Release\` environment for GitHub release
          4. ✅ After approval: GitHub release created pointing to the existing tag
          5. 🔀 Ready to merge to main

          **Tags are created automatically, but GitHub releases require approval!**" \
            --base main \
            --head ${{ steps.branch_info.outputs.branch_name }}

      - name: Create Hotfix Pull Request
        if: inputs.type == 'hotfix'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Hotfix ${{ steps.parse_version.outputs.branch_name }}" \
            --body "🔥 **Hotfix branch ${{ steps.parse_version.outputs.branch_name }}**

          **Created from tag:** \`${{ inputs.tag }}\`

          ## What happens when you push to this branch:
          1. 📝 Semantic-release updates package.json and changelog automatically
          2. 🏷️ Semantic-release creates git tag automatically
          3. ⏸️ Workflow pauses for manual approval in \`Release\` environment for GitHub release
          4. ✅ After approval: GitHub release created pointing to the existing tag
          5. 🔀 Ready to merge to main

          **Tags are created automatically, but GitHub releases require approval!**" \
            --base main \
            --head ${{ steps.parse_version.outputs.branch_name }}
