name: Create Release Branch

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to create branch from (optional, defaults to main)'
        required: false
        type: string

jobs:
  create-branch:
    permissions:
      contents: write
      actions: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: Generate release branch name
        id: release_branch
        run: |
          # For releases, use date-based naming
          CURRENT_DATE=$(date +%Y-%m-%d)
          SHORT_SHA=$(git rev-parse --short HEAD)
          BRANCH_NAME="release/v${CURRENT_DATE}-${SHORT_SHA}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "üìù Generated release branch name: $BRANCH_NAME"

      - name: Check if branch already exists
        run: |
          BRANCH_NAME="${{ steps.release_branch.outputs.branch_name }}"
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q refs; then
            echo "‚ùå Branch $BRANCH_NAME already exists"
            exit 1
          fi
          echo "‚úÖ Branch $BRANCH_NAME is available"

      - name: Create branch
        run: |
          BRANCH_NAME="${{ steps.release_branch.outputs.branch_name }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"
          
          git checkout main

          if [ -n "$COMMIT_SHA" ]; then
            echo "üìç Creating release branch from commit: $COMMIT_SHA"
            git checkout -b "$BRANCH_NAME" "$COMMIT_SHA"
          else
            echo "üìç Creating release branch from main"
            git checkout -b "$BRANCH_NAME"
          fi

          git push origin "$BRANCH_NAME"

      - name: Output success message
        run: |
          BRANCH_NAME="${{ steps.release_branch.outputs.branch_name }}"
          COMMIT_SHA="${{ inputs.commit_sha }}"

          echo "‚úÖ Release branch created: $BRANCH_NAME"

          if [ -n "$COMMIT_SHA" ]; then
            echo "üìç Created from commit: $COMMIT_SHA"
          else
            echo "üìç Created from main branch"
          fi

          echo ""
          echo "üöÄ Release Branch Instructions:"
          echo "1. Push commits to this branch to trigger create-release-pull-request.yml"
          echo "2. Semantic-release will run and create version/tag automatically"
          echo "3. A PR will be created automatically when workflow completes"
          echo "4. Review and merge the PR to complete the release"