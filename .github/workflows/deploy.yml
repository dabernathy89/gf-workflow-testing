# Deployment workflow - deploys from release/hotfix branches with manual approval
name: Deploy

on:
  push:
    branches:
      - 'release/v**'
      - 'hotfix/v**'

jobs:
  check-for-production-deployment:
    name: Check for Production Deployment
    runs-on: ubuntu-latest
    outputs:
      should_deploy_prod: ${{ steps.check_tags.outputs.should_deploy_prod }}
      production_version: ${{ steps.check_tags.outputs.production_version }}
      branch_type: ${{ steps.check_branch.outputs.branch_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch type
        id: check_branch
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" == hotfix/* ]]; then
            echo "branch_type=hotfix" >> $GITHUB_OUTPUT
            echo "üî• Detected hotfix branch: $BRANCH_NAME"
          elif [[ "$BRANCH_NAME" == release/* ]]; then
            echo "branch_type=release" >> $GITHUB_OUTPUT
            echo "üöÄ Detected release branch: $BRANCH_NAME"
          else
            echo "branch_type=unknown" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Unknown branch type: $BRANCH_NAME"
          fi

      - name: Check for production deployment
        id: check_tags
        run: |
          echo "Checking for release tags on current commit..."

          # Get current commit SHA
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_COMMIT"

          # Check if current commit has a release tag (semantic version format)
          RELEASE_TAG=$(git tag --points-at $CURRENT_COMMIT | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

          if [ -n "$RELEASE_TAG" ]; then
            VERSION=${RELEASE_TAG#v}  # Remove 'v' prefix
            echo "should_deploy_prod=true" >> $GITHUB_OUTPUT
            echo "production_version=$VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Found release tag $RELEASE_TAG - production deployment approved"
          else
            echo "should_deploy_prod=false" >> $GITHUB_OUTPUT
            echo "production_version=" >> $GITHUB_OUTPUT
            echo "üì¶ No release tag found - development/staging deployment only"
          fi

  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [check-for-production-deployment]
    environment: Release  # üîë Manual approval required here!
    steps:
      - name: Dummy checkout and setup
        run: echo "Simulating repository checkout and AWS configuration..."

      - name: Dummy ECR login
        id: login-ecr
        run: |
          echo "Logging into Amazon ECR..."
          echo "registry=123456789.dkr.ecr.us-east-1.amazonaws.com" >> $GITHUB_OUTPUT
          echo "‚úÖ Successfully logged into ECR"

      - name: Dummy image metadata preparation
        id: image_meta
        env:
          SHOULD_DEPLOY_PROD: ${{ needs.check-for-production-deployment.outputs.should_deploy_prod }}
          PRODUCTION_VERSION: ${{ needs.check-for-production-deployment.outputs.production_version }}
          BRANCH_TYPE: ${{ needs.check-for-production-deployment.outputs.branch_type }}
        run: |
          echo "Preparing Docker image metadata..."
          timestamp=$(date +%s)
          BRANCH_NAME="${{ github.ref_name }}"

          # Always create dev tag with branch info
          dev_tag="some.ecr.url:${BRANCH_TYPE}-${timestamp}-abc1234"
          tags="${dev_tag}"

          # Add production tag if this is an approved release
          if [ "$SHOULD_DEPLOY_PROD" = "true" ]; then
            prod_tag="some.ecr.url:${PRODUCTION_VERSION}"
            tags="${tags},${prod_tag}"
            echo "üéØ Production deployment enabled - adding production tag: $prod_tag"
          else
            echo "üì¶ Development/staging deployment only - no production tag"
          fi

          echo "tags=${tags}" >> $GITHUB_OUTPUT
          echo "timestamp=${timestamp}" >> $GITHUB_OUTPUT
          echo "dev_tag=${dev_tag}" >> $GITHUB_OUTPUT
          echo "üåø Deploying from branch: $BRANCH_NAME"

      - name: Dummy Docker build
        run: |
          echo "Setting up Docker buildx..."
          echo "Building Docker image with multi-platform support..."
          echo "üì¶ Image built successfully for linux/amd64"
          echo "üîÑ Loading image for asset extraction"

      - name: Dummy asset publishing
        env:
          BRANCH_TYPE: ${{ needs.check-for-production-deployment.outputs.branch_type }}
          SHOULD_DEPLOY_PROD: ${{ needs.check-for-production-deployment.outputs.should_deploy_prod }}
        run: |
          echo "Extracting assets from Docker container..."
          echo "Creating temporary container for asset extraction"
          echo "Extracting /usr/share/nginx/html/ directory"

          if [ "$SHOULD_DEPLOY_PROD" = "true" ]; then
            echo "Syncing assets to S3 production bucket..."
          else
            echo "Syncing assets to S3 ${BRANCH_TYPE} environment bucket..."
          fi

          echo "‚úÖ Assets published to S3 successfully"
          echo "üßπ Cleaned up temporary files"

      - name: Dummy ECR image push
        env:
          SHOULD_DEPLOY_PROD: ${{ needs.check-for-production-deployment.outputs.should_deploy_prod }}
          PRODUCTION_VERSION: ${{ needs.check-for-production-deployment.outputs.production_version }}
          BRANCH_TYPE: ${{ needs.check-for-production-deployment.outputs.branch_type }}
        run: |
          echo "Pushing images to Amazon ECR..."
          timestamp=$(date +%s)
          echo "üì§ Pushing ${BRANCH_TYPE} tag: ${BRANCH_TYPE}-${timestamp}-abc1234"

          if [ "$SHOULD_DEPLOY_PROD" = "true" ]; then
            echo "üì§ Pushing production tag: ${PRODUCTION_VERSION}"
            echo "‚úÖ Both ${BRANCH_TYPE} and production images pushed successfully to ECR"
          else
            echo "‚è≠Ô∏è Skipping production tag push (no approved release)"
            echo "‚úÖ ${BRANCH_TYPE} image pushed successfully to ECR"
          fi

      - name: Dummy metadata update
        env:
          SHOULD_DEPLOY_PROD: ${{ needs.check-for-production-deployment.outputs.should_deploy_prod }}
          PRODUCTION_VERSION: ${{ needs.check-for-production-deployment.outputs.production_version }}
          BRANCH_TYPE: ${{ needs.check-for-production-deployment.outputs.branch_type }}
        run: |
          echo "Updating environment metadata files..."

          if [ "$BRANCH_TYPE" = "release" ]; then
            echo "üìù Updated dev metadata: devt-webapp-meta.json"
            echo "üìù Updated staging metadata: stag-webapp-meta.json"
          elif [ "$BRANCH_TYPE" = "hotfix" ]; then
            echo "üìù Updated staging metadata: stag-webapp-meta.json (hotfix testing)"
          fi

          # Update production metadata only for approved releases
          if [ "$SHOULD_DEPLOY_PROD" = "true" ]; then
            echo "üìù Updated production metadata: prod-webapp-meta.json"
            echo "‚úÖ Updated production metadata for version ${PRODUCTION_VERSION}"
          else
            echo "‚è≠Ô∏è Skipping production metadata update (no approved release)"
          fi

      - name: Deployment summary
        env:
          SHOULD_DEPLOY_PROD: ${{ needs.check-for-production-deployment.outputs.should_deploy_prod }}
          PRODUCTION_VERSION: ${{ needs.check-for-production-deployment.outputs.production_version }}
          BRANCH_TYPE: ${{ needs.check-for-production-deployment.outputs.branch_type }}
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìã Type: ${BRANCH_TYPE}"

          if [ "$SHOULD_DEPLOY_PROD" = "true" ]; then
            echo "üöÄ Production deployment: ‚úÖ (version ${PRODUCTION_VERSION})"
            echo "üåç Environments updated: Development, Staging, Production"
          else
            echo "üöÄ Production deployment: ‚ùå (no release tag)"
            if [ "$BRANCH_TYPE" = "release" ]; then
              echo "üåç Environments updated: Development, Staging"
            else
              echo "üåç Environments updated: Staging (hotfix testing)"
            fi
          fi
