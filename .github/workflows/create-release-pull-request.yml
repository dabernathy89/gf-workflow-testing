name: Create Release Pull Request

on:
  push:
    branches:
      - 'release/v**'

jobs:
  version-tag-pull-request:
    name: Version, Tag, and Create PR
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semrel.outputs.version }}
      tag_name: ${{ steps.create_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run semantic-release
        id: semrel
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          echo "üè∑Ô∏è Running semantic-release (version, changelog, and tagging)"
          npx semantic-release --debug

      - name: Create tag output for release
        id: create_tag
        if: steps.semrel.outputs.version
        run: |
          TAG_NAME="v${{ steps.semrel.outputs.version }}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Version: ${{ steps.semrel.outputs.version }}"
          echo "üè∑Ô∏è Tag created: $TAG_NAME"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        if: steps.semrel.outputs.version
        with:
          token: ${{ secrets.REPO_PAT }}
          branch: ${{ github.ref_name }}
          title: "Release ${{ steps.create_tag.outputs.tag }}"
          body: |
            üöÄ Release ${{ steps.create_tag.outputs.tag }}

            This PR contains the release branch for version ${{ steps.semrel.outputs.version }}.

            ## Changes
            - Version bumped to ${{ steps.semrel.outputs.version }}
            - Changelog updated
            - Tag ${{ steps.create_tag.outputs.tag }} created

            ## ‚ö†Ô∏è Important Merge Instructions
            **DO NOT use "Squash and merge"** - Use only "Create a merge commit" (DO NOT use "Squash and merge" or "Rebase and merge") to preserve the git tag on the correct commit for production deployment.

            Ready for review and merge to main.
          base: main

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: version-tag-pull-request
    if: needs.version-tag-pull-request.outputs.version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          TAG_NAME="${{ needs.version-tag-pull-request.outputs.tag_name }}"

          echo "üöÄ Creating GitHub release for tag $TAG_NAME"

          # Check if release already exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Release $TAG_NAME already exists, skipping release creation"
            exit 0
          fi

          # Check if tag exists
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG_NAME does not exist. Make sure the version-tag-pull-request job has run successfully."
            exit 1
          fi

          # Create release with auto-generated notes
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --generate-notes \
            --latest
          echo "‚úÖ GitHub release $TAG_NAME created successfully"