name: Create Release Pull Request

on:
  push:
    branches:
      - 'release/v**'

jobs:
  version-and-tag:
    name: Version and Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semrel.outputs.version }}
      tag_name: ${{ steps.create_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run semantic-release
        id: semrel
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          echo "🏷️ Running semantic-release (version, changelog, and tagging)"
          npx semantic-release --debug

      - name: Create tag output for release
        id: create_tag
        if: steps.semrel.outputs.version
        run: |
          TAG_NAME="v${{ steps.semrel.outputs.version }}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "✅ Version: ${{ steps.semrel.outputs.version }}"
          echo "🏷️ Tag created: $TAG_NAME"

  create-pull-request:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: version-and-tag
    if: needs.version-and-tag.outputs.version
    steps:
      - name: Checkout and fetch latest changes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.REPO_PAT }}

      - name: Fetch latest release branch changes
        run: |
          echo "🔄 Fetching latest changes from release branch after semantic-release"
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}
          echo "📋 Current branch status:"
          git log --oneline -5

      - name: Create Pull Request from release branch to main
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.REPO_PAT }}
          branch: ${{ github.ref_name }}
          title: "Release ${{ needs.version-and-tag.outputs.tag_name }}"
          body: |
            🚀 Release ${{ needs.version-and-tag.outputs.tag_name }}

            This PR contains the release branch for version ${{ needs.version-and-tag.outputs.version }}.

            ## Changes
            - Version bumped to ${{ needs.version-and-tag.outputs.version }}
            - Changelog updated
            - Tag ${{ needs.version-and-tag.outputs.tag_name }} created

            ## ⚠️ Important Merge Instructions
            **DO NOT use "Squash and merge"** - Use only "Create a merge commit" (DO NOT use "Squash and merge" or "Rebase and merge") to preserve the git tag on the correct commit for production deployment.

            Ready for review and merge to main.
          base: main
          draft: true